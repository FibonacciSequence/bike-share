<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lima Bike Share</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <style>
    body { background: #f9f9f9; }
    .bike-card img { max-height: 180px; object-fit: cover; }
    .wa-btn { background-color: #25D366 !important; }
    
    /* Nuevos estilos para alinear tarjetas */
    .equal-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .equal-card .card-content {
      flex-grow: 1;
    }
    .equal-card img {
      height: 180px;
      object-fit: cover;
      width: 100%;
    }
    .equal-card .card-action {
      margin-top: auto;
    }
  </style>
</head>
<body class="container">
  <h3 class="center-align">üö≤ Lima Bike Share</h3>

  <!-- Formulario -->
  <div class="card">
    <div class="card-content">
      <span class="card-title">Agregar una bici</span>
      <form id="addBikeForm">
        <div class="input-field">
          <input id="bikeName" type="text" required>
          <label for="bikeName">Nombre de la bici</label>
        </div>
        <div class="input-field">
          <input id="bikeLocation" type="text" required>
          <label for="bikeLocation">Ubicaci√≥n</label>
        </div>
        <div class="input-field">
          <input id="bikeWhatsapp" type="text" placeholder="+51 999 999 999" required>
          <label for="bikeWhatsapp">WhatsApp</label>
        </div>
        <div class="input-field">
          <input id="bikePrice" type="number" required>
          <label for="bikePrice">Precio (por hora)</label>
        </div>
        <div class="file-field input-field">
          <div class="btn">
            <span>Foto</span>
            <input type="file" id="photoInput" accept="image/*">
          </div>
          <div class="file-path-wrapper">
            <input class="file-path validate" type="text" placeholder="Sube una foto de la bici">
          </div>
        </div>
        <button class="btn waves-effect waves-light" type="submit">Agregar</button>
      </form>
    </div>
  </div>

  <!-- Lista de bicis -->
  <div id="bikeList" class="row"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "878883777843688",
      authDomain: "bike-share-lima.firebaseapp.com",
      projectId: "bike-share-lima",
      storageBucket: "bike-share-lima.appspot.com",
      messagingSenderId: "742260721560",
      appId: "1:742260721560:web:38831f59c1080a0b818ded"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üöÄ Subir a Cloudinary
    async function uploadToCloudinary(file) {
      const url = `https://api.cloudinary.com/v1_1/dzscwbwey/image/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "mdidemll"); 

      const response = await fetch(url, { method: "POST", body: formData });
      const data = await response.json();
      return data.secure_url;
    }

    // üöÄ Agregar bici
    document.getElementById("addBikeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = document.getElementById("photoInput").files[0];
      let photoURL = "";

      if (file) {
        photoURL = await uploadToCloudinary(file);
      }

      await addDoc(collection(db, "bikes"), {
        name: document.getElementById("bikeName").value,
        location: document.getElementById("bikeLocation").value,
        whatsapp: document.getElementById("bikeWhatsapp").value,
        price: document.getElementById("bikePrice").value,
        photo: photoURL,
        createdAt: serverTimestamp()
      });

      e.target.reset();
      M.updateTextFields();
      M.toast({ html: "‚úÖ Bici agregada" });
    });

    // üöÄ Mostrar bicis en tiempo real
    const q = query(collection(db, "bikes"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      const bikeList = document.getElementById("bikeList");
      bikeList.innerHTML = "";
      snapshot.forEach((doc) => {
        const bike = doc.data();
        bikeList.innerHTML += `
          <div class="col s12 m6 l4">
            <div class="card equal-card hoverable">
              <div class="card-image">
                <img src="${bike.photo}" alt="${bike.name}">
              </div>
              <div class="card-content">
                <span class="card-title truncate">${bike.name}</span>
                <p><strong>üìç Ubicaci√≥n:</strong> ${bike.location}</p>
                <p><strong>üí∞ Precio:</strong> S/ ${bike.price} por hora</p>
              </div>
              <div class="card-action">
                <a class="btn wa-btn waves-effect waves-light" target="_blank" href="https://wa.me/${bike.whatsapp.replace(/\D/g,'')}">
                  üí¨ WhatsApp
                </a>
              </div>
            </div>
          </div>
        `;
      });
    });
  </script>
</body>
</html>